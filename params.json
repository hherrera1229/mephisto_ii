{"name":"Mephisto II","tagline":"Building an internet radio with the Raspberry Pi","body":"# Motivation\r\n\r\nInspired by [mightyohms internet radio] (http://mightyohm.com/blog/2008/10/building-a-wifi-radio-part-1-introduction/) I decided to build one on my own too. \r\nSo I build my first radio with an **Asus WL520-GU router** and an [Arduino Ethernet as UI controller] (http://www.instructables.com/id/Standalone-WiFi-Radio-Control-Panel-Arduino-Power/): \r\n[**Mephisto I**](https://github.com/syd711/mephisto_i).\r\n\r\nThe project has been so much fun that\r\nI decided to build another one, but with a cheaper and more efficient hardware by choosing the **Raspberry Pi**.\r\n\r\n# The Name\r\n\r\nWhy Mephisto II? Well, my last name means \"fist\" in German (Faust) and this is the second radio I build, so...\r\n\r\n# The Radio Box\r\n\r\nWhat? Wait? Why starting with the box? Well, I learned from my first project that I neither have the tools nor the room to build a box on my own. So I decided to lookup a possible box first and  \r\nbuild the radio depending on the design of the choosen box. The radio is a gift for a woman who's got an old-fashioned furniture style, so I bought a [radio box from 1932] (http://www.radiomuseum.org/r/brandt_lw80_lw_80.html) from ebay and started \"hacking\".\r\n\r\n![Box 1](http://www.paderpoint.net/radio/tn_IMG_6583.JPG)\r\n![Box 2](http://www.paderpoint.net/radio/tn_IMG_6584.JPG)\r\n\r\n\r\n# The Hardware\r\n\r\nComponents used:\r\n* Radio box\r\n* Raspberry Pi\r\n* Raspberry Pi GPIO Cobbler\r\n* Lepai Mini Hi-Fi HiFi Stereo Audio Amplifier \r\n* USB Hub 4-port\r\n* Visaton BG 20 speaker\r\n* 2x 74HC595 8 bit shift register\r\n* USB power adapter for the Raspi\r\n* power adapter for the Lepai amp\r\n* a relay that switches the power source for the Raspi once the amp is turned on\r\n* 12x LED for the front display\r\n* 1x LED as power indicator on the front (the 3mm hole was already there, so I used this as for a power LED)\r\n* rotary encoder for station selection\r\n* on/off switch\r\n* ...and blood, sweat and tears ;)\r\n\r\n### Problems, Solutions and Open Issues (Hardware)\r\n* **the Raspberry Pi GPIO ports**: Because of the limited space on the front side, I decided to provide a display where the user can select one of twelve stations. Using 3mm LEDs this was the amount of LEDs \r\nthat fit into the front hole. The problem was that Raspi does not have that many GPIO ports, so I found **[this] (http://bildr.org/2011/02/74hc595/)** awesome article for the **Arduino** that did the trick.\r\n* **the Lepai amp**: The amp wasn't the best choice for this project but does what it is intended to do. Problem: the amp produces a constant noise which is pretty annoying. I solved this problem by wiring \r\na 50 Ohm resistor on the speaker to reduce the noise. Does someone has a recommendation for an amp in that price category (14â‚¬)? \r\n* **the rotary encoder**: **GRRRRRRR - BIGGEST PAIN EVER**. I was able to get the rotary encoder running on an Arduino Uno. So I translated the Arduino code to python and wired it to the Raspi. After fiddling\r\naround for hours I wasn't able to get the rotary encoder running the same way. I tried the a [pythong rotary encoder library] (https://github.com/guyc/py-gaugette) on Github but found contradictorily wiring schemes\r\nfor the rotary encoder. I wired the A/B pins to GPIO ports on the Raspi but it only works on one direction. I wasn't able to fix this problem yet and for me, it's still the biggest bug on the radio.\r\n\r\n\r\n\r\n# The Software\r\n\r\nWith the power of the Raspberry Pi I decided to build a web-interface the user can configure the stations with. \r\nSince I already fiddled around with the awesome **[Adafruit Web IDE] (http://learn.adafruit.com/webide/overview)**, I decided to use **Python** for the REST service \r\nand **[jquery-mobile] (http://jquerymobile.com/demos/1.3.0/)** for a responsive web UI. I've never programmed Python before, thinking everything is better than PHP, but realized soon that Python is a bit of a pain too. \r\nBut building the UI using the **[bottle] (http://bottlepy.org/docs/dev/index.html)** \r\n REST framework was fun and I achieved the desired results in really short time. So I decided to give the radio some \"extras\". I stumbled over the **[gmusic-python API on github] (https://github.com/simon-weber/Unofficial-Google-Music-API)** and decided that it would be nice if the\r\nradio could play **all my mp3** as well. So I build an UI for that too. You can see some screenshots below. The UI is in German, but I think you get the idea:\r\n\r\n![Radio Control](http://www.paderpoint.net/radio/tn_2013-05-24%2019_29_17-Verwaltung.png)\r\n![Radio Control](http://www.paderpoint.net/radio/tn_2013-05-24%2019_30_35-Radio%20Verwaltung.png)\r\n![GMusic Control](http://www.paderpoint.net/radio/tn_2013-05-24%2019_30_04-Google%20Music.png)\r\n\r\n### Problems, Solutions and Open Issues (Software)\r\n\r\nBecause this was ...\r\n* my first Raspberry Pi project\r\n* the first time I programmed Python\r\n* the first time I used jquery-mobile (jquery at all) \r\n* and my first project with the Adafruit Web IDE\r\n\r\nI stumbled over some problems. Some of them I could solve, some of them remained unsolved. I want to share my knowledge here (and hopefully get some answers to my questions too). \r\nHere is a short overview about the main problems I faced building the software for the radio.\r\n\r\n* **working with the Adafruit WebIDE**: This was no problem at all. I left the IDE enabled in the radio. When the radio is booting, the Python scripts are executed right from the workspace which allows me to make minor fixes afterwards.\r\n* **performance of the bottle framework**: I did not spent much time googling which framework to use for a Python REST service. The bottle framework worked for me, although I soon realized \r\nthat there are some performance issues using the default webserver, so I installed **cherrypy** and started the service with this server instead: <pre>run(host=SETTING_SERVER_IP, port=SETTING_SERVER_PORT, debug=False, server='cherrypy')</pre>\r\n* **using one mpd for two services**: mpd is used for the playback of the radio stations and also for the Google music support. That means the once a song should be played from Google, the REST layer has to clean up the \r\ncurrent playlist from the radio stations and add the URL of the mp3 to the list. I mananged that by storing two different playlist that are persisted with the corresponding mpc commands. Once the user leaves the Google menu, \r\nthe radio playlist is loaded again to ensure that the persisted stations are working again. If a station is selected on the radio, a check is made if the radio playlist is loaded and re-applies the radio playlist to the mpd.\r\nIf the radio was turned off while playing songs from Google, the radio loads the radio playlist during the startup, starting the playback with the first station.\r\n* **mpc library**: For some reasons I did not check if Python mpc libraries are out there (of course there are). So I implemented a mpc helper class that executes \r\nmpc system commands and mpc telnet commands for handling the playlist. There is definitly room for improvements here.\r\n* **logging**: I did not care much about logging and used a static helper class for this too. This could have been better too.\r\n* **Google music playback**: The main problem here was that the playback URLs of the library are only valid from some restricted time. Therefore loading a complete playlist for an album or an artist was not possible. \r\nI fixed the problem by running a separate player thread that only checks if the given song is still playing and if there is a next song that should be play from the current album/artist list. As a result, there is always\r\nonly one song in the playlist. The UI is updated via polling the player thread status every n seconds. The playback URL is only resolved when a song should be actually played.\r\n* **radio remote control**: The UI supports a remote control for the radio so that the next or previous station can be selected. Maybe it would be better here to let the user choose a station directly.\r\nUnfortunatly the LEDs for the station status are not updated when the station is changed via remote control.\r\n* **radio remote volume control**: In a first version I was able to control the radio volume control via UI with a jquery-mobile slider component. The slider change did result in a **mpc volume** command on the server side. \r\nAfter using an USB sound card, the command did not work anymore and I wasn't able to get it running again. The UI component is still there, but commented out in the HTML. \r\n* **passing correct stream urls to the UI**: The \"New Station\" dialog contains a test button for new stream URLs. The URLs may work when configuring the playlist on a PC but may not when added to the mpd playlist.\r\nA nice solution would be to have some a kind of stream repository that is maintained in the outside world so the user only selected his or her radio stations from a list of predefined stations.\r\n\r\n\r\n# Conclusion\r\n\r\nOnce again, it was fun to build an internet radio on my own. And I'm looking forward to \"make\" my next project, even though I don't know yet what it's gonna be. Here are some additional fotos of the build process:\r\n\r\n![Speaker installation] (http://www.paderpoint.net/radio/tn_IMG_6616.JPG)\r\n![Front Panel Control] (http://www.paderpoint.net/radio/tn_IMG_6617.JPG)\r\n![Front Panel] (http://www.paderpoint.net/radio/tn_IMG_6618.JPG)\r\n![Prototyping] (http://www.paderpoint.net/radio/tn_IMG_6619.JPG)\r\n![Wiring] (http://www.paderpoint.net/radio/tn_IMG_6620.JPG)\r\n![Wiring] (http://www.paderpoint.net/radio/tn_IMG_6621.JPG)\r\n![Wiring] (http://www.paderpoint.net/radio/tn_IMG_6622.JPG)\r\n![Wiring] (http://www.paderpoint.net/radio/tn_IMG_6623.JPG)\r\n\r\n![Finished Radio] (http://www.paderpoint.net/radio/tn_2013-05-26%2012.51.00.jpg)\r\n![Finished Radio] (http://www.paderpoint.net/radio/tn_2013-05-26%2012.51.13.jpg)\r\n![Finished Radio] (http://www.paderpoint.net/radio/tn_2013-05-26%2012.51.24.jpg)","google":"UA-41233430-1","note":"Don't delete this file! It's used internally to help with page regeneration."}